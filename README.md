# permaversion

CLI utility for tracking and updating versions of permaweb applications registered with ArNS. Works well as a complimentary tool with [permaweb-deploy](https://github.com/permaweb/permaweb-deploy).

Credit to [permaweb-deploy][permaweb-deploy](https://github.com/permaweb/permaweb-deploy) for inspiration and re-used code. 

### Features
- **Version Tracking:**  Updates a record of versions deployed to an ArNS name. 
- **ArNS Update:** Updates ArNS with version record using an optional template website. 
- **Automated Workflow:** Integrates with GitHub Actions for continuous deployment.

### Overview

`permaversion` operates as follows:

1. Takes input:
   - Source Ant process ID and undername
   - Target "versions" Ant process ID and undername

2. Reads the current targetId for the source ArNS record

3. Retrieves the current versions.json from the target versions record
   - If no versions.json exists, a new one is created

4. Adds a new version entry to versions.json using the source's targetId

5. Generates and uploads an updated versions site (including versions.json) to Arweave

6. Updates the target versions record with the new version site's transaction ID (txid)

The versions site is generated using a template website provided by the user. The template website can be developed however the user would like to create it, but it must load a versions.json file at runtime to operate with the permaversion tool. 

When `permaversion` goes to update the versions site on arweave, it will copy the template site to versions-site-dist and then save or overwrite the versions.json file with the new versions.json file generated by the tool. The updated website is then uploaded to Arweave, and the target versions record is updated with the new txid.


### Installation
Install the package using npm:
```bash
npm install permaversion
```

### Prerequisites

Like `permaweb-deploy`, before using `permaversion`, you must:
1. Encode your Arweave wallet key in base64 format and set it as a GitHub secret:

   ```bash
   base64 -i wallet.json | pbcopy
   ```
3. Ensure that the secret name for the encoded wallet is `DEPLOY_KEY`.

### Usage

To deploy your application, ensure you have a build script and a deployment script in your `package.json`:

```json
"scripts": {
    "build": "your-build-command",
    "deploy-main": "npm run build && permaweb-deploy --ant-process <ANT_PROCESS> --undername <UNDERNAME>",
    "deploy-versions": "permaversion --ant-process <VERSIONS_ANT_PROCESS> --undername <VERSIONS_UNDERNAME> --source-ant-process <ANT_PROCESS> --source-ant-undername <UNDERNAME>",
    "deploy": "npm run deploy-main && npm run deploy-versions"
}
```

Replace relevant `<PROCESS>` and `<UNDERNAME>` values with your actual ANT processes and undernames.

The commandline options are as follows:

```
Options:
      --help                  Show help                                [boolean]
      --version               Show version number                      [boolean]
  -a, --ant-process           ANT process ID to update       [string] [required]
  -d, --template-folder       Folder containing version site template to deploy.
                               If no folder is provided, a directory with just t
                              he versions.json will be deployed.
                                           [string] [default: "./versions-site"]
  -u, --undername             ANT undername to update.   [string] [default: "@"]
      --source-ant-process    Source ANT process ID to read target ID from.
                                                             [string] [required]
      --source-ant-undername  Source ANT undername to read target ID from.
                                                         [string] [default: "@"]
  -g, --gateway               Arweave gateway FQDN
                                               [string] [default: "arweave.net"]
      --additional-fields     Additional fields to add to the ANT record
                                                                   [default: {}]
      --dry-run               Generate versions-site-dist but do not upload or u
                              pdate ANT record.       [boolean] [default: false]
      --deploy-dist           Only deploy current versions-site-dist folder and
                              update ANT record.      [boolean] [default: false]
```

### Useful Tips

- Use `--dry-run` during development to test the generated tool and to see what the generated site and versions.json will look like. You can use the generated versions.json and add it to your template site to test how additional-field values will appear.
- Use `--deploy-dist` to skip versions site generation and deploy directly from the current versions-site-dist. This is useful if you need to update the versions.json manually, such as when there is an errant deployment of the main site, or if you decide later to add additional fields to your release information.
- Use `--additional-fields` to add additional fields to the version record. The only fields that are generated in a versions.json by default are `txId` and `timestamp`. This generates versions.json like so:

```json
{
  "versions": [
    {
      "txId": "-BEV5FHG-YJj-RT1KYUutttJSgXobJA4rJtSPsyRsEU",
      "timestamp": 1723572760443,
    }
  ],
  "previousVersionsSiteTxId": "j7Gl66TQFAcP_bkxqKgLCJULCgcytW2Gby6woRO13mw"
}
```

If using ```--additional-fields.version="1.0.0"``` when deploying, `permaversion` would generate a version record like so:

```json
{
  "versions": [
    {
      "txId": "-BEV5FHG-YJj-RT1KYUutttJSgXobJA4rJtSPsyRsEU",
      "timestamp": 1723572760443,
      "version": "1.0.0"
    }
  ],
  "previousVersionsSiteTxId": "j7Gl66TQFAcP_bkxqKgLCJULCgcytW2Gby6woRO13mw"
}
```

You can attach any additional fields you want to the version record using this method and update your template site to read that information.


### Important Notes
- **Security:** Always use a dedicated wallet for deployments to minimize risk.
- **Wallet Key:** The wallet must be base64 encoded to be used in the deployment script.
